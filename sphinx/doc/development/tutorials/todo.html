<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Developing a “TODO” extension &#8212; techwords 01 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=4f649999" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=039e1c02" />
    <script src="../../../_static/documentation_options.js?v=82a30901"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="developing-a-todo-extension">
<h1>Developing a “TODO” extension<a class="headerlink" href="#developing-a-todo-extension" title="Link to this heading">¶</a></h1>
<p>The objective of this tutorial is to create a more comprehensive extension than
that created in <a class="reference internal" href="helloworld.html"><span class="doc">Developing a “Hello world” extension</span></a>. Whereas that guide just covered writing a
custom <a class="reference internal" href="../../glossary.html#term-directive"><span class="xref std std-term">directive</span></a>, this guide adds multiple directives, along with custom
nodes, additional config values and custom event handlers. To this end, we will
cover a <code class="docutils literal notranslate"><span class="pre">todo</span></code> extension that adds capabilities to include todo entries in the
documentation, and to collect these in a central place. This is similar the
<code class="docutils literal notranslate"><span class="pre">sphinxext.todo</span></code> extension distributed with Sphinx.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To understand the design of this extension, refer to
<a class="reference internal" href="../../extdev/index.html#important-objects"><span class="std std-ref">Important objects</span></a> and <a class="reference internal" href="../../extdev/index.html#build-phases"><span class="std std-ref">Build Phases</span></a>.</p>
</div>
<p>We want the extension to add the following to Sphinx:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">todo</span></code> directive, containing some content that is marked with “TODO” and
only shown in the output if a new config value is set. Todo entries should not
be in the output by default.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">todolist</span></code> directive that creates a list of all todo entries throughout
the documentation.</p></li>
</ul>
<p>For that, we will need to add the following elements to Sphinx:</p>
<ul class="simple">
<li><p>New directives, called <code class="docutils literal notranslate"><span class="pre">todo</span></code> and <code class="docutils literal notranslate"><span class="pre">todolist</span></code>.</p></li>
<li><p>New document tree nodes to represent these directives, conventionally also
called <code class="docutils literal notranslate"><span class="pre">todo</span></code> and <code class="docutils literal notranslate"><span class="pre">todolist</span></code>.  We wouldn’t need new nodes if the new
directives only produced some content representable by existing nodes.</p></li>
<li><p>A new config value <code class="docutils literal notranslate"><span class="pre">todo_include_todos</span></code> (config value names should start
with the extension name, in order to stay unique) that controls whether todo
entries make it into the output.</p></li>
<li><p>New event handlers: one for the <a href="#id1"><span class="problematic" id="id2">:event:`doctree-resolved`</span></a> event, to
replace the todo and todolist nodes, one for <a href="#id3"><span class="problematic" id="id4">:event:`env-merge-info`</span></a>
to merge intermediate results from parallel builds, and one for
<a href="#id5"><span class="problematic" id="id6">:event:`env-purge-doc`</span></a> (the reason for that will be covered later).</p></li>
</ul>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<p>As with <a class="reference internal" href="helloworld.html"><span class="doc">Developing a “Hello world” extension</span></a>, we will not be distributing this plugin via PyPI so
once again we need a Sphinx project to call this from. You can use an existing
project or create a new one using <strong class="program">sphinx-quickstart</strong>.</p>
<p>We assume you are using separate source (<code class="file docutils literal notranslate"><span class="pre">source</span></code>) and build
(<code class="file docutils literal notranslate"><span class="pre">build</span></code>) folders. Your extension file could be in any folder of your
project. In our case, let’s do the following:</p>
<ol class="arabic simple">
<li><p>Create an <code class="file docutils literal notranslate"><span class="pre">_ext</span></code> folder in <code class="file docutils literal notranslate"><span class="pre">source</span></code></p></li>
<li><p>Create a new Python file in the <code class="file docutils literal notranslate"><span class="pre">_ext</span></code> folder called <code class="file docutils literal notranslate"><span class="pre">todo.py</span></code></p></li>
</ol>
<p>Here is an example of the folder structure you might obtain:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>└── source
    ├── _ext
    │   └── todo.py
    ├── _static
    ├── conf.py
    ├── somefolder
    ├── index.rst
    ├── somefile.rst
    └── someotherfile.rst
</pre></div>
</div>
</section>
<section id="writing-the-extension">
<h2>Writing the extension<a class="headerlink" href="#writing-the-extension" title="Link to this heading">¶</a></h2>
<p>Open <code class="file docutils literal notranslate"><span class="pre">todo.py</span></code> and paste the following code in it, all of which we will
explain in detail shortly:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="linenos">  2</span><span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>
<span class="linenos">  3</span>
<span class="linenos">  4</span><span class="kn">from</span> <span class="nn">sphinx.locale</span> <span class="kn">import</span> <span class="n">_</span>
<span class="linenos">  5</span><span class="kn">from</span> <span class="nn">sphinx.util.docutils</span> <span class="kn">import</span> <span class="n">SphinxDirective</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="k">class</span> <span class="nc">todo</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
<span class="linenos">  9</span>    <span class="k">pass</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="k">class</span> <span class="nc">todolist</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">General</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
<span class="linenos"> 13</span>    <span class="k">pass</span>
<span class="linenos"> 14</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="k">def</span> <span class="nf">visit_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="linenos"> 17</span>    <span class="bp">self</span><span class="o">.</span><span class="n">visit_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="linenos"> 18</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span><span class="k">def</span> <span class="nf">depart_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="linenos"> 21</span>    <span class="bp">self</span><span class="o">.</span><span class="n">depart_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span><span class="k">class</span> <span class="nc">TodolistDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 27</span>        <span class="k">return</span> <span class="p">[</span><span class="n">todolist</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>
<span class="linenos"> 28</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span><span class="k">class</span> <span class="nc">TodoDirective</span><span class="p">(</span><span class="n">SphinxDirective</span><span class="p">):</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span>    <span class="c1"># this enables content in the directive</span>
<span class="linenos"> 33</span>    <span class="n">has_content</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 36</span>        <span class="n">targetid</span> <span class="o">=</span> <span class="s1">&#39;todo-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">new_serialno</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">)</span>
<span class="linenos"> 37</span>        <span class="n">targetnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">targetid</span><span class="p">])</span>
<span class="linenos"> 38</span>
<span class="linenos"> 39</span>        <span class="n">todo_node</span> <span class="o">=</span> <span class="n">todo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="linenos"> 40</span>        <span class="n">todo_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">))</span>
<span class="linenos"> 41</span>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nested_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_offset</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">)</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos"> 44</span>            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 45</span>
<span class="linenos"> 46</span>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos"> 47</span>            <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span>
<span class="linenos"> 48</span>            <span class="s1">&#39;lineno&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
<span class="linenos"> 49</span>            <span class="s1">&#39;todo&#39;</span><span class="p">:</span> <span class="n">todo_node</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
<span class="linenos"> 50</span>            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">targetnode</span><span class="p">,</span>
<span class="linenos"> 51</span>        <span class="p">})</span>
<span class="linenos"> 52</span>
<span class="linenos"> 53</span>        <span class="k">return</span> <span class="p">[</span><span class="n">targetnode</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">]</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span>
<span class="linenos"> 56</span><span class="k">def</span> <span class="nf">purge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
<span class="linenos"> 57</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos"> 58</span>        <span class="k">return</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span>    <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[</span><span class="n">todo</span> <span class="k">for</span> <span class="n">todo</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span>
<span class="linenos"> 61</span>                          <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">docname</span><span class="p">]</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span>
<span class="linenos"> 64</span><span class="k">def</span> <span class="nf">merge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="linenos"> 65</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos"> 66</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 67</span>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos"> 68</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">)</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span>
<span class="linenos"> 71</span><span class="k">def</span> <span class="nf">process_todo_nodes</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">):</span>
<span class="linenos"> 72</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
<span class="linenos"> 73</span>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">todo</span><span class="p">):</span>
<span class="linenos"> 74</span>            <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>    <span class="c1"># Replace all todolist nodes with a list of the collected todos.</span>
<span class="linenos"> 77</span>    <span class="c1"># Augment each todo with a backlink to the original location.</span>
<span class="linenos"> 78</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">env</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos"> 81</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">todolist</span><span class="p">):</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
<span class="linenos"> 85</span>            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">([])</span>
<span class="linenos"> 86</span>            <span class="k">continue</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>        <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 89</span>
<span class="linenos"> 90</span>        <span class="k">for</span> <span class="n">todo_info</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">:</span>
<span class="linenos"> 91</span>            <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
<span class="linenos"> 92</span>            <span class="n">filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 93</span>            <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 94</span>                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;(The original entry is located in </span><span class="si">%s</span><span class="s1">, line </span><span class="si">%d</span><span class="s1"> and can be found &#39;</span><span class="p">)</span> <span class="o">%</span>
<span class="linenos"> 95</span>                <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">]))</span>
<span class="linenos"> 96</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>            <span class="c1"># Create a reference</span>
<span class="linenos"> 99</span>            <span class="n">newnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="linenos">100</span>            <span class="n">innernode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">emphasis</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">))</span>
<span class="linenos">101</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refdocname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span>
<span class="linenos">102</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span>
<span class="linenos">103</span>                <span class="n">fromdocname</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">])</span>
<span class="linenos">104</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
<span class="linenos">105</span>            <span class="n">newnode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">innernode</span><span class="p">)</span>
<span class="linenos">106</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">newnode</span>
<span class="linenos">107</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;.)&#39;</span><span class="p">)</span>
<span class="linenos">108</span>
<span class="linenos">109</span>            <span class="c1"># Insert into the todolist</span>
<span class="linenos">110</span>            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;todo&#39;</span><span class="p">])</span>
<span class="linenos">111</span>            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
<span class="linenos">112</span>
<span class="linenos">113</span>        <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="linenos">114</span>
<span class="linenos">115</span>
<span class="linenos">116</span><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="linenos">117</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;todo_include_todos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
<span class="linenos">118</span>
<span class="linenos">119</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todolist</span><span class="p">)</span>
<span class="linenos">120</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span>
<span class="linenos">121</span>                 <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
<span class="linenos">122</span>                 <span class="n">latex</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
<span class="linenos">123</span>                 <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">))</span>
<span class="linenos">124</span>
<span class="linenos">125</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">,</span> <span class="n">TodoDirective</span><span class="p">)</span>
<span class="linenos">126</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todolist&#39;</span><span class="p">,</span> <span class="n">TodolistDirective</span><span class="p">)</span>
<span class="linenos">127</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;doctree-resolved&#39;</span><span class="p">,</span> <span class="n">process_todo_nodes</span><span class="p">)</span>
<span class="linenos">128</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="n">purge_todos</span><span class="p">)</span>
<span class="linenos">129</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-merge-info&#39;</span><span class="p">,</span> <span class="n">merge_todos</span><span class="p">)</span>
<span class="linenos">130</span>
<span class="linenos">131</span>    <span class="k">return</span> <span class="p">{</span>
<span class="linenos">132</span>        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
<span class="linenos">133</span>        <span class="s1">&#39;parallel_read_safe&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">134</span>        <span class="s1">&#39;parallel_write_safe&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">135</span>    <span class="p">}</span>
</pre></div>
</div>
<p>This is far more extensive extension than the one detailed in <a class="reference internal" href="helloworld.html"><span class="doc">Developing a “Hello world” extension</span></a>,
however, we will will look at each piece step-by-step to explain what’s
happening.</p>
<p class="rubric">The node classes</p>
<p>Let’s start with the node classes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">todo</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="k">pass</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span> <span class="nc">todolist</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">General</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
<span class="linenos"> 6</span>    <span class="k">pass</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span><span class="k">def</span> <span class="nf">visit_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="linenos">10</span>    <span class="bp">self</span><span class="o">.</span><span class="n">visit_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="linenos">11</span>
<span class="linenos">12</span>
<span class="linenos">13</span><span class="k">def</span> <span class="nf">depart_todo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="linenos">14</span>    <span class="bp">self</span><span class="o">.</span><span class="n">depart_admonition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
<p>Node classes usually don’t have to do anything except inherit from the standard
docutils classes defined in <code class="xref py py-mod docutils literal notranslate"><span class="pre">docutils.nodes</span></code>.  <code class="docutils literal notranslate"><span class="pre">todo</span></code> inherits from
<code class="docutils literal notranslate"><span class="pre">Admonition</span></code> because it should be handled like a note or warning, <code class="docutils literal notranslate"><span class="pre">todolist</span></code>
is just a “general” node.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Many extensions will not have to create their own node classes and work fine
with the nodes already provided by <a class="reference external" href="https://docutils.sourceforge.io/docs/ref/doctree.html">docutils</a> and <a class="reference internal" href="../../extdev/nodes.html#nodes"><span class="std std-ref">Sphinx</span></a>.</p>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>It is important to know that while you can extend Sphinx without
leaving your <code class="docutils literal notranslate"><span class="pre">conf.py</span></code>, if you declare an inherited node right
there, you’ll hit an unobvious <code class="xref py py-class docutils literal notranslate"><span class="pre">PickleError</span></code>. So if
something goes wrong, please make sure that you put inherited nodes
into a separate Python module.</p>
<p>For more details, see:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/sphinx-doc/sphinx/issues/6751">https://github.com/sphinx-doc/sphinx/issues/6751</a></p></li>
<li><p><a class="reference external" href="https://github.com/sphinx-doc/sphinx/issues/1493">https://github.com/sphinx-doc/sphinx/issues/1493</a></p></li>
<li><p><a class="reference external" href="https://github.com/sphinx-doc/sphinx/issues/1424">https://github.com/sphinx-doc/sphinx/issues/1424</a></p></li>
</ul>
</div>
<p class="rubric">The directive classes</p>
<p>A directive class is a class deriving usually from
<a class="reference internal" href="../../extdev/markupapi.html#docutils.parsers.rst.Directive" title="docutils.parsers.rst.Directive"><code class="xref py py-class docutils literal notranslate"><span class="pre">docutils.parsers.rst.Directive</span></code></a>. The directive interface is also
covered in detail in the <a class="reference external" href="https://docutils.sourceforge.io/docs/ref/rst/directives.html">docutils documentation</a>; the important thing is that
the class should have attributes that configure the allowed markup, and a
<code class="docutils literal notranslate"><span class="pre">run</span></code> method that returns a list of nodes.</p>
<p>Looking first at the <code class="docutils literal notranslate"><span class="pre">TodolistDirective</span></code> directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">class</span> <span class="nc">TodolistDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>
<span class="linenos">2</span>
<span class="linenos">3</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">4</span>        <span class="k">return</span> <span class="p">[</span><span class="n">todolist</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>It’s very simple, creating and returning an instance of our <code class="docutils literal notranslate"><span class="pre">todolist</span></code> node
class.  The <code class="docutils literal notranslate"><span class="pre">TodolistDirective</span></code> directive itself has neither content nor
arguments that need to be handled. That brings us to the <code class="docutils literal notranslate"><span class="pre">TodoDirective</span></code>
directive:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">class</span> <span class="nc">TodoDirective</span><span class="p">(</span><span class="n">SphinxDirective</span><span class="p">):</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="c1"># this enables content in the directive</span>
<span class="linenos"> 4</span>    <span class="n">has_content</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 7</span>        <span class="n">targetid</span> <span class="o">=</span> <span class="s1">&#39;todo-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">new_serialno</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">)</span>
<span class="linenos"> 8</span>        <span class="n">targetnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">target</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="n">targetid</span><span class="p">])</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>        <span class="n">todo_node</span> <span class="o">=</span> <span class="n">todo</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="linenos">11</span>        <span class="n">todo_node</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">))</span>
<span class="linenos">12</span>        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nested_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_offset</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">)</span>
<span class="linenos">13</span>
<span class="linenos">14</span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos">15</span>            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<span class="linenos">18</span>            <span class="s1">&#39;docname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span>
<span class="linenos">19</span>            <span class="s1">&#39;lineno&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
<span class="linenos">20</span>            <span class="s1">&#39;todo&#39;</span><span class="p">:</span> <span class="n">todo_node</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(),</span>
<span class="linenos">21</span>            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">targetnode</span><span class="p">,</span>
<span class="linenos">22</span>        <span class="p">})</span>
<span class="linenos">23</span>
<span class="linenos">24</span>        <span class="k">return</span> <span class="p">[</span><span class="n">targetnode</span><span class="p">,</span> <span class="n">todo_node</span><span class="p">]</span>
</pre></div>
</div>
<p>Several important things are covered here. First, as you can see, we’re now
subclassing the <code class="xref py py-class docutils literal notranslate"><span class="pre">SphinxDirective</span></code> helper class
instead of the usual <a class="reference internal" href="../../extdev/markupapi.html#docutils.parsers.rst.Directive" title="docutils.parsers.rst.Directive"><code class="xref py py-class docutils literal notranslate"><span class="pre">Directive</span></code></a> class. This
gives us access to the <a class="reference internal" href="../../extdev/index.html#important-objects"><span class="std std-ref">build environment instance</span></a>
using the <code class="docutils literal notranslate"><span class="pre">self.env</span></code> property. Without this, we’d have to use the rather
convoluted <code class="docutils literal notranslate"><span class="pre">self.state.document.settings.env</span></code>. Then, to act as a link target
(from <code class="docutils literal notranslate"><span class="pre">TodolistDirective</span></code>), the <code class="docutils literal notranslate"><span class="pre">TodoDirective</span></code> directive needs to return a
target node in addition to the <code class="docutils literal notranslate"><span class="pre">todo</span></code> node.  The target ID (in HTML, this will
be the anchor name) is generated by using <code class="docutils literal notranslate"><span class="pre">env.new_serialno</span></code> which returns a
new unique integer on each call and therefore leads to unique target names. The
target node is instantiated without any text (the first two arguments).</p>
<p>On creating admonition node, the content body of the directive are parsed using
<code class="docutils literal notranslate"><span class="pre">self.state.nested_parse</span></code>.  The first argument gives the content body, and
the second one gives content offset.  The third argument gives the parent node
of parsed result, in our case the <code class="docutils literal notranslate"><span class="pre">todo</span></code> node. Following this, the <code class="docutils literal notranslate"><span class="pre">todo</span></code>
node is added to the environment.  This is needed to be able to create a list of
all todo entries throughout the documentation, in the place where the author
puts a <code class="docutils literal notranslate"><span class="pre">todolist</span></code> directive.  For this case, the environment attribute
<code class="docutils literal notranslate"><span class="pre">todo_all_todos</span></code> is used (again, the name should be unique, so it is prefixed
by the extension name).  It does not exist when a new environment is created, so
the directive must check and create it if necessary.  Various information about
the todo entry’s location are stored along with a copy of the node.</p>
<p>In the last line, the nodes that should be put into the doctree are returned:
the target node and the admonition node.</p>
<p>The node structure that the directive returns looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">target</span> <span class="n">node</span>        <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="n">todo</span> <span class="n">node</span>          <span class="o">|</span>
<span class="o">+--------------------+</span>
  \<span class="n">__</span><span class="o">+--------------------+</span>
     <span class="o">|</span> <span class="n">admonition</span> <span class="n">title</span>   <span class="o">|</span>
     <span class="o">+--------------------+</span>
     <span class="o">|</span> <span class="n">paragraph</span>          <span class="o">|</span>
     <span class="o">+--------------------+</span>
     <span class="o">|</span> <span class="o">...</span>                <span class="o">|</span>
     <span class="o">+--------------------+</span>
</pre></div>
</div>
<p class="rubric">The event handlers</p>
<p>Event handlers are one of Sphinx’s most powerful features, providing a way to
do hook into any part of the documentation process. There are many events
provided by Sphinx itself, as detailed in <a class="reference internal" href="../../extdev/appapi.html#events"><span class="std std-ref">the API guide</span></a>, and
we’re going to use a subset of them here.</p>
<p>Let’s look at the event handlers used in the above example.  First, the one for
the <a href="#id7"><span class="problematic" id="id8">:event:`env-purge-doc`</span></a> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">purge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos">3</span>        <span class="k">return</span>
<span class="linenos">4</span>
<span class="linenos">5</span>    <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[</span><span class="n">todo</span> <span class="k">for</span> <span class="n">todo</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span>
<span class="linenos">6</span>                          <span class="k">if</span> <span class="n">todo</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">docname</span><span class="p">]</span>
</pre></div>
</div>
<p>Since we store information from source files in the environment, which is
persistent, it may become out of date when the source file changes.  Therefore,
before each source file is read, the environment’s records of it are cleared,
and the <a href="#id9"><span class="problematic" id="id10">:event:`env-purge-doc`</span></a> event gives extensions a chance to do the same.
Here we clear out all todos whose docname matches the given one from the
<code class="docutils literal notranslate"><span class="pre">todo_all_todos</span></code> list.  If there are todos left in the document, they will be
added again during parsing.</p>
<p>The next handler, for the <a href="#id11"><span class="problematic" id="id12">:event:`env-merge-info`</span></a> event, is used
during parallel builds. As during parallel builds all threads have
their own <code class="docutils literal notranslate"><span class="pre">env</span></code>, there’s multiple <code class="docutils literal notranslate"><span class="pre">todo_all_todos</span></code> lists that need
to be merged:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">def</span> <span class="nf">merge_todos</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="linenos">2</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos">3</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">4</span>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos">5</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">)</span>
</pre></div>
</div>
<p>The other handler belongs to the <a href="#id13"><span class="problematic" id="id14">:event:`doctree-resolved`</span></a> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">process_todo_nodes</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
<span class="linenos"> 3</span>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">todo</span><span class="p">):</span>
<span class="linenos"> 4</span>            <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="c1"># Replace all todolist nodes with a list of the collected todos.</span>
<span class="linenos"> 7</span>    <span class="c1"># Augment each todo with a backlink to the original location.</span>
<span class="linenos"> 8</span>    <span class="n">env</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">env</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s1">&#39;todo_all_todos&#39;</span><span class="p">):</span>
<span class="linenos">11</span>        <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">12</span>
<span class="linenos">13</span>    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">todolist</span><span class="p">):</span>
<span class="linenos">14</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">todo_include_todos</span><span class="p">:</span>
<span class="linenos">15</span>            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">([])</span>
<span class="linenos">16</span>            <span class="k">continue</span>
<span class="linenos">17</span>
<span class="linenos">18</span>        <span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">19</span>
<span class="linenos">20</span>        <span class="k">for</span> <span class="n">todo_info</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">todo_all_todos</span><span class="p">:</span>
<span class="linenos">21</span>            <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
<span class="linenos">22</span>            <span class="n">filename</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">23</span>            <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">24</span>                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;(The original entry is located in </span><span class="si">%s</span><span class="s1">, line </span><span class="si">%d</span><span class="s1"> and can be found &#39;</span><span class="p">)</span> <span class="o">%</span>
<span class="linenos">25</span>                <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;lineno&#39;</span><span class="p">]))</span>
<span class="linenos">26</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
<span class="linenos">27</span>
<span class="linenos">28</span>            <span class="c1"># Create a reference</span>
<span class="linenos">29</span>            <span class="n">newnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="linenos">30</span>            <span class="n">innernode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">emphasis</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">),</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">))</span>
<span class="linenos">31</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refdocname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span>
<span class="linenos">32</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span>
<span class="linenos">33</span>                <span class="n">fromdocname</span><span class="p">,</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">])</span>
<span class="linenos">34</span>            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
<span class="linenos">35</span>            <span class="n">newnode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">innernode</span><span class="p">)</span>
<span class="linenos">36</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">newnode</span>
<span class="linenos">37</span>            <span class="n">para</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;.)&#39;</span><span class="p">)</span>
<span class="linenos">38</span>
<span class="linenos">39</span>            <span class="c1"># Insert into the todolist</span>
<span class="linenos">40</span>            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">todo_info</span><span class="p">[</span><span class="s1">&#39;todo&#39;</span><span class="p">])</span>
<span class="linenos">41</span>            <span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
<span class="linenos">42</span>
<span class="linenos">43</span>        <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a href="#id15"><span class="problematic" id="id16">:event:`doctree-resolved`</span></a> event is emitted at the end of <a class="reference internal" href="../../extdev/index.html#build-phases"><span class="std std-ref">phase 3
(resolving)</span></a> and allows custom resolving to be done. The handler
we have written for this event is a bit more involved. If the
<code class="docutils literal notranslate"><span class="pre">todo_include_todos</span></code> config value (which we’ll describe shortly) is false,
all <code class="docutils literal notranslate"><span class="pre">todo</span></code> and <code class="docutils literal notranslate"><span class="pre">todolist</span></code> nodes are removed from the documents. If not,
<code class="docutils literal notranslate"><span class="pre">todo</span></code> nodes just stay where and how they are.  <code class="docutils literal notranslate"><span class="pre">todolist</span></code> nodes are
replaced by a list of todo entries, complete with backlinks to the location
where they come from.  The list items are composed of the nodes from the
<code class="docutils literal notranslate"><span class="pre">todo</span></code> entry and docutils nodes created on the fly: a paragraph for each
entry, containing text that gives the location, and a link (reference node
containing an italic node) with the backreference. The reference URI is built
by <code class="xref py py-meth docutils literal notranslate"><span class="pre">sphinx.builders.Builder.get_relative_uri()</span></code> which creates a suitable
URI depending on the used builder, and appending the todo node’s (the target’s)
ID as the anchor name.</p>
<p class="rubric">The <code class="docutils literal notranslate"><span class="pre">setup</span></code> function</p>
<p>As noted <a class="reference internal" href="helloworld.html"><span class="doc">previously</span></a>, the <code class="docutils literal notranslate"><span class="pre">setup</span></code> function is a requirement
and is used to plug directives into Sphinx. However, we also use it to hook up
the other parts of our extension. Let’s look at our <code class="docutils literal notranslate"><span class="pre">setup</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
<span class="linenos"> 2</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;todo_include_todos&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">)</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todolist</span><span class="p">)</span>
<span class="linenos"> 5</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">todo</span><span class="p">,</span>
<span class="linenos"> 6</span>                 <span class="n">html</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
<span class="linenos"> 7</span>                 <span class="n">latex</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">),</span>
<span class="linenos"> 8</span>                 <span class="n">text</span><span class="o">=</span><span class="p">(</span><span class="n">visit_todo_node</span><span class="p">,</span> <span class="n">depart_todo_node</span><span class="p">))</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todo&#39;</span><span class="p">,</span> <span class="n">TodoDirective</span><span class="p">)</span>
<span class="linenos">11</span>    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;todolist&#39;</span><span class="p">,</span> <span class="n">TodolistDirective</span><span class="p">)</span>
<span class="linenos">12</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;doctree-resolved&#39;</span><span class="p">,</span> <span class="n">process_todo_nodes</span><span class="p">)</span>
<span class="linenos">13</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="n">purge_todos</span><span class="p">)</span>
<span class="linenos">14</span>    <span class="n">app</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;env-merge-info&#39;</span><span class="p">,</span> <span class="n">merge_todos</span><span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="k">return</span> <span class="p">{</span>
<span class="linenos">17</span>        <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
<span class="linenos">18</span>        <span class="s1">&#39;parallel_read_safe&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">19</span>        <span class="s1">&#39;parallel_write_safe&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos">20</span>    <span class="p">}</span>
</pre></div>
</div>
<p>The calls in this function refer to the classes and functions we added earlier.
What the individual calls do is the following:</p>
<ul>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_config_value()</span></code> lets Sphinx know that it should recognize the
new <em>config value</em> <code class="docutils literal notranslate"><span class="pre">todo_include_todos</span></code>, whose default value should be
<code class="docutils literal notranslate"><span class="pre">False</span></code> (this also tells Sphinx that it is a boolean value).</p>
<p>If the third argument was <code class="docutils literal notranslate"><span class="pre">'html'</span></code>, HTML documents would be full rebuild if the
config value changed its value.  This is needed for config values that
influence reading (build <a class="reference internal" href="../../extdev/index.html#build-phases"><span class="std std-ref">phase 1 (reading)</span></a>).</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_node()</span></code> adds a new <em>node class</em> to the build system.  It also
can specify visitor functions for each supported output format.  These visitor
functions are needed when the new nodes stay until <a class="reference internal" href="../../extdev/index.html#build-phases"><span class="std std-ref">phase 4 (writing)</span></a>. Since the <code class="docutils literal notranslate"><span class="pre">todolist</span></code> node is always replaced in
<a class="reference internal" href="../../extdev/index.html#build-phases"><span class="std std-ref">phase 3 (resolving)</span></a>, it doesn’t need any.</p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">add_directive()</span></code> adds a new <em>directive</em>, given by name and class.</p></li>
<li><p>Finally, <code class="xref py py-meth docutils literal notranslate"><span class="pre">connect()</span></code> adds an <em>event handler</em> to the event whose
name is given by the first argument.  The event handler function is called
with several arguments which are documented with the event.</p></li>
</ul>
<p>With this, our extension is complete.</p>
</section>
<section id="using-the-extension">
<h2>Using the extension<a class="headerlink" href="#using-the-extension" title="Link to this heading">¶</a></h2>
<p>As before, we need to enable the extension by declaring it in our
<code class="file docutils literal notranslate"><span class="pre">conf.py</span></code> file. There are two steps necessary here:</p>
<ol class="arabic simple">
<li><p>Add the <code class="file docutils literal notranslate"><span class="pre">_ext</span></code> directory to the <a class="reference external" href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONPATH">Python path</a> using
<code class="docutils literal notranslate"><span class="pre">sys.path.append</span></code>. This should be placed at the top of the file.</p></li>
<li><p>Update or create the <a href="#id17"><span class="problematic" id="id18">:confval:`extensions`</span></a> list and add the extension file
name to the list</p></li>
</ol>
<p>In addition, we may wish to set the <code class="docutils literal notranslate"><span class="pre">todo_include_todos</span></code> config value. As
noted above, this defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code> but we can set it explicitly.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;./_ext&quot;</span><span class="p">))</span>

<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;todo&#39;</span><span class="p">]</span>

<span class="n">todo_include_todos</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>You can now use the extension throughout your project. For example:</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">index.rst</span><a class="headerlink" href="#id19" title="Link to this code">¶</a></div>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="gh">Hello, world</span>
<span class="gh">============</span>

<span class="p">..</span> <span class="ow">toctree</span><span class="p">::</span>
   somefile.rst
   someotherfile.rst

Hello world. Below is the list of TODOs.

<span class="p">..</span> <span class="ow">todolist</span><span class="p">::</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">somefile.rst</span><a class="headerlink" href="#id20" title="Link to this code">¶</a></div>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="gh">foo</span>
<span class="gh">===</span>

Some intro text here...

<span class="p">..</span> <span class="ow">todo</span><span class="p">::</span> Fix this
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">someotherfile.rst</span><a class="headerlink" href="#id21" title="Link to this code">¶</a></div>
<div class="highlight-rst notranslate"><div class="highlight"><pre><span></span><span class="gh">bar</span>
<span class="gh">===</span>

Some more text here...

<span class="p">..</span> <span class="ow">todo</span><span class="p">::</span> Fix that
</pre></div>
</div>
</div>
<p>Because we have configured <code class="docutils literal notranslate"><span class="pre">todo_include_todos</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>, we won’t
actually see anything rendered for the <code class="docutils literal notranslate"><span class="pre">todo</span></code> and <code class="docutils literal notranslate"><span class="pre">todolist</span></code> directives.
However, if we toggle this to true, we will see the output described
previously.</p>
</section>
<section id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Link to this heading">¶</a></h2>
<p>For more information, refer to the <a class="reference external" href="https://docutils.sourceforge.io/docs/">docutils</a> documentation and
<span class="xref std std-doc">/extdev/index</span>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">techwords</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, techwords.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../../_sources/doc/development/tutorials/todo.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>